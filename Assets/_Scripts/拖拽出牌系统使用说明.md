# Unity 卡牌游戏拖拽出牌系统使用说明

## 系统概述

这个拖拽出牌系统为Unity卡牌游戏提供了完整的拖拽和出牌功能，包括：
- 卡牌拖拽交互
- 出牌区域检测
- 费用系统集成
- 视觉反馈

## 核心组件

### 1. CardDragSystem (卡牌拖拽系统)
- **位置**: `Assets/_Scripts/System/CardDragSystem.cs`
- **功能**: 管理所有卡牌的拖拽逻辑
- **特性**: 单例模式，自动管理拖拽状态

### 2. PlayArea (出牌区域)
- **位置**: `Assets/_Scripts/Data/PlayArea.cs`
- **功能**: 定义卡牌可以放置的区域
- **特性**: 支持卡牌类型限制、数量限制、费用检查

### 3. CardDragBehavior (卡牌拖拽行为)
- **位置**: `Assets/_Scripts/Views/CardDragBehavior.cs`
- **功能**: 处理单个卡牌的拖拽输入
- **特性**: 支持点击和拖拽，自动集成到CardView

### 4. CardSystem (卡牌系统)
- **位置**: `Assets/_Scripts/System/CardSystem.cs`
- **功能**: 管理卡牌的游戏逻辑
- **特性**: 费用管理、手牌管理、出牌验证

### 5. DragSystemSetup (设置工具)
- **位置**: `Assets/_Scripts/Tools/DragSystemSetup.cs`
- **功能**: 快速设置拖拽系统
- **特性**: 自动配置所有必要组件

## 快速开始

### 方法1: 使用自动设置工具

1. 在场景中创建一个空的GameObject
2. 添加 `DragSystemSetup` 组件
3. 在Inspector中点击 "设置拖拽系统" 按钮
4. 系统会自动：
   - 创建CardDragSystem
   - 为所有CardView添加拖拽行为
   - 创建默认的出牌区域

### 方法2: 手动设置

1. **创建CardDragSystem**
   ```csharp
   // 在场景中创建空GameObject，添加CardDragSystem组件
   GameObject dragSystemObj = new GameObject("CardDragSystem");
   dragSystemObj.AddComponent<CardDragSystem>();
   ```

2. **为卡牌添加拖拽行为**
   ```csharp
   // 为每个CardView添加CardDragBehavior组件
   CardView cardView = GetComponent<CardView>();
   cardView.gameObject.AddComponent<CardDragBehavior>();
   ```

3. **创建出牌区域**
   ```csharp
   // 创建出牌区域GameObject
   GameObject playArea = new GameObject("PlayArea");
   playArea.AddComponent<PlayArea>();
   playArea.AddComponent<BoxCollider2D>().isTrigger = true;
   ```

## 详细配置

### CardDragSystem 配置

```csharp
[Header("拖拽设置")]
[SerializeField] private float dragThreshold = 0.1f; // 拖拽阈值
[SerializeField] private float dragScale = 1.2f; // 拖拽时缩放
[SerializeField] private LayerMask playAreaLayer = 1; // 出牌区域层级
```

### PlayArea 配置

```csharp
[Header("出牌区域设置")]
[SerializeField] private bool requireSpecificCardType = false; // 是否需要特定卡牌类型
[SerializeField] private string[] allowedCardTypes = new string[0]; // 允许的卡牌类型
[SerializeField] private int maxCards = -1; // 最大卡牌数量 (-1=无限制)
[SerializeField] private bool checkCost = true; // 是否检查费用
```

### CardDragBehavior 配置

```csharp
[Header("拖拽设置")]
[SerializeField] private bool enableDrag = true; // 是否启用拖拽
[SerializeField] private float dragThreshold = 0.1f; // 拖拽阈值
```

## 使用方法

### 基本拖拽出牌

1. 玩家点击并拖拽卡牌
2. 系统显示可出牌区域的高亮
3. 拖拽到有效区域并释放
4. 系统验证费用和规则
5. 成功出牌或返回原位置

### 代码示例

```csharp
// 获取拖拽系统
CardDragSystem dragSystem = CardDragSystem.Instance;

// 检查是否正在拖拽
if (dragSystem.IsDragging)
{
    CardView draggedCard = dragSystem.DraggedCard;
    Debug.Log($"正在拖拽: {draggedCard.Card.Name}");
}

// 获取卡牌系统
CardSystem cardSystem = FindObjectOfType<CardSystem>();

// 添加卡牌到手牌
cardSystem.AddCardToHand(cardView);

// 检查费用
if (cardSystem.CanAffordCard(card))
{
    Debug.Log("可以出牌");
}
```

## 事件系统

### CardSystem 事件

```csharp
[Header("事件")]
[SerializeField] private UnityEvent<CardView> onCardPlayed; // 出牌事件
[SerializeField] private UnityEvent<CardView> onCardDrawn; // 抽牌事件
```

### 监听事件

```csharp
// 在Inspector中绑定事件，或在代码中监听
cardSystem.onCardPlayed.AddListener(OnCardPlayed);
cardSystem.onCardDrawn.AddListener(OnCardDrawn);

private void OnCardPlayed(CardView cardView)
{
    Debug.Log($"卡牌被出牌: {cardView.Card.Name}");
}
```

## 自定义扩展

### 创建自定义出牌区域

```csharp
public class CustomPlayArea : PlayArea
{
    protected override void OnCardPlayed(CardView cardView)
    {
        base.OnCardPlayed(cardView);
        
        // 自定义出牌逻辑
        Debug.Log($"在自定义区域出牌: {cardView.Card.Name}");
        
        // 添加特殊效果
        cardView.transform.DOScale(1.2f, 0.2f).SetLoops(2, LoopType.Yoyo);
    }
}
```

### 自定义拖拽行为

```csharp
public class CustomCardDragBehavior : CardDragBehavior
{
    protected override void OnCardClicked()
    {
        base.OnCardClicked();
        
        // 自定义点击逻辑
        Debug.Log("自定义点击处理");
    }
}
```

## 注意事项

1. **性能优化**: 大量卡牌时考虑对象池
2. **UI层级**: 确保拖拽的卡牌在最上层显示
3. **输入处理**: 确保EventSystem存在且正常工作
4. **相机设置**: 确保主相机正确设置
5. **碰撞检测**: 出牌区域需要Collider2D组件

## 故障排除

### 常见问题

1. **卡牌无法拖拽**
   - 检查CardDragBehavior组件是否存在
   - 确认EventSystem存在
   - 检查enableDrag是否为true

2. **出牌区域不响应**
   - 检查PlayArea组件是否存在
   - 确认Collider2D设置为Trigger
   - 检查层级设置

3. **费用检查不工作**
   - 确认CardSystem存在
   - 检查费用设置
   - 验证CanAffordCard方法

### 调试技巧

```csharp
// 启用调试日志
Debug.Log($"拖拽状态: {CardDragSystem.Instance.IsDragging}");
Debug.Log($"当前费用: {cardSystem.CurrentMana}");
Debug.Log($"手牌数量: {cardSystem.HandSize}");
```

## 更新日志

- v1.0: 初始版本，基本拖拽出牌功能
- 支持费用系统集成
- 支持多种出牌区域类型
- 提供自动设置工具
